<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Hospital Management System - API Connection Test</h1>
    <p>This page tests the connection to the backend API from your current location.</p>
    
    <div>
        <button onclick="testConnection()">Test Basic Connection</button>
        <button onclick="testStatistics()">Test Statistics API</button>
        <button onclick="testDashboardData()">Test Dashboard Data</button>
        <button onclick="testAllEndpoints()">Test All Endpoints</button>
    </div>
    
    <div id="results"></div>

    <script>
        const API_BASE_URL = 'http://192.168.50.171:5000';
        
        function addResult(message, type = 'loading') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = message;
            resultsDiv.appendChild(resultDiv);
            return resultDiv;
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        async function testConnection() {
            clearResults();
            const resultDiv = addResult('Testing basic connection...', 'loading');
            
            try {
                const response = await fetch(`${API_BASE_URL}/test`);
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'test-result success';
                    resultDiv.innerHTML = `
                        <strong>✅ Connection Successful!</strong><br>
                        Status: ${data.status}<br>
                        Message: ${data.message}<br>
                        Database Test: ${data.dbTest}<br>
                        Timestamp: ${data.timestamp}
                    `;
                } else {
                    throw new Error(`HTTP ${response.status}: ${data.message || 'Unknown error'}`);
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `
                    <strong>❌ Connection Failed!</strong><br>
                    Error: ${error.message}<br>
                    <br>
                    <strong>Possible solutions:</strong><br>
                    1. Check if the server is running on 192.168.50.171:5000<br>
                    2. Verify network connectivity to the server<br>
                    3. Check firewall settings<br>
                    4. Ensure you're on the same network
                `;
            }
        }
        
        async function testStatistics() {
            clearResults();
            const resultDiv = addResult('Testing statistics API...', 'loading');
            
            try {
                console.log('Fetching statistics from:', `${API_BASE_URL}/statistics`);
                const response = await fetch(`${API_BASE_URL}/statistics`);
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (response.ok) {
                    resultDiv.className = 'test-result success';
                    resultDiv.innerHTML = `
                        <strong>✅ Statistics API Working!</strong><br>
                        <strong>Dashboard Counts:</strong><br>
                        • Birth Count: ${data.totalBirths || 0}<br>
                        • Death Count: ${data.totalDeaths || 0}<br>
                        • Total Registrations: ${data.totalRegistrations || 0}<br>
                        • Mortuary Records: ${data.totalMortuary || 0}<br>
                        <br>
                        <strong>Raw Response:</strong><br>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    throw new Error(`HTTP ${response.status}: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `
                    <strong>❌ Statistics API Failed!</strong><br>
                    Error: ${error.message}<br>
                    <br>
                    <strong>Troubleshooting:</strong><br>
                    1. Check browser console for detailed errors<br>
                    2. Verify server is running on 192.168.50.171:5000<br>
                    3. Check database connection<br>
                    4. Test individual endpoints below
                `;
                console.error('Statistics API error:', error);
            }
        }
        
        async function testDashboardData() {
            clearResults();
            addResult('Testing dashboard data sources...', 'loading');
            
            // Test statistics endpoint
            try {
                const statsResponse = await fetch(`${API_BASE_URL}/statistics`);
                const statsData = await statsResponse.json();
                
                if (statsResponse.ok) {
                    addResult(`✅ Statistics API: Birth=${statsData.totalBirths}, Death=${statsData.totalDeaths}, Total=${statsData.totalRegistrations}, Mortuary=${statsData.totalMortuary}`, 'success');
                } else {
                    addResult(`❌ Statistics API failed: ${statsData.error}`, 'error');
                }
            } catch (error) {
                addResult(`❌ Statistics API error: ${error.message}`, 'error');
            }
            
            // Test individual endpoints as fallback
            try {
                const birthResponse = await fetch(`${API_BASE_URL}/birthRecords`);
                const birthData = await birthResponse.json();
                const birthCount = Array.isArray(birthData) ? birthData.length : 0;
                addResult(`✅ Birth Records: ${birthCount} records found`, 'success');
            } catch (error) {
                addResult(`❌ Birth Records error: ${error.message}`, 'error');
            }
            
            try {
                const deathResponse = await fetch(`${API_BASE_URL}/deathRecords`);
                const deathData = await deathResponse.json();
                const deathCount = Array.isArray(deathData) ? deathData.length : 0;
                addResult(`✅ Death Records: ${deathCount} records found`, 'success');
            } catch (error) {
                addResult(`❌ Death Records error: ${error.message}`, 'error');
            }
            
            try {
                const parentResponse = await fetch(`${API_BASE_URL}/ParentData`);
                const parentData = await parentResponse.json();
                const parentCount = Array.isArray(parentData) ? parentData.length : 0;
                addResult(`✅ Parent Data: ${parentCount} records found`, 'success');
            } catch (error) {
                addResult(`❌ Parent Data error: ${error.message}`, 'error');
            }
        }
        
        async function testAllEndpoints() {
            clearResults();
            
            const endpoints = [
                { name: 'Health Check', url: '/health' },
                { name: 'Test Endpoint', url: '/test' },
                { name: 'Statistics', url: '/statistics' },
                { name: 'Birth Records', url: '/birthRecords' },
                { name: 'Death Records', url: '/deathRecords' },
                { name: 'Parent Data', url: '/ParentData' },
                { name: 'Recent Activities', url: '/activities/recent' }
            ];
            
            for (const endpoint of endpoints) {
                const resultDiv = addResult(`Testing ${endpoint.name}...`, 'loading');
                
                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint.url}`);
                    const data = await response.json();
                    
                    if (response.ok) {
                        resultDiv.className = 'test-result success';
                        resultDiv.innerHTML = `
                            <strong>✅ ${endpoint.name}</strong><br>
                            Status: ${response.status}<br>
                            Records: ${Array.isArray(data) ? data.length : 'N/A'}
                        `;
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    resultDiv.className = 'test-result error';
                    resultDiv.innerHTML = `
                        <strong>❌ ${endpoint.name}</strong><br>
                        Error: ${error.message}
                    `;
                }
                
                // Small delay between requests
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }
    </script>
</body>
</html>